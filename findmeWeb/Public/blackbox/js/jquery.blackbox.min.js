/*
 * BlackBox - jQuery Plugin
 * version: 0.7 (31/08/2012)
 * @requires jQuery v1.6 or later
 *
 *
 * Copyright 2012 Alvin Tin  - tin@alvin.im , Xworm - xworm@xworm.net 
 * Company toWords - toWords.com
 * License : MIT License / GPL License
 * 
 */

(function(e,t,n,r){var i=n(e),s=n(t);BlackBox=function(e){this.config={clickBackgrounEffert:"shake",backgroundColor:!1,blackgroundImage:!1,backgroundImageType:!1,forceLoad:!0,allowPromptBlank:!1,allowBoxScrolling:!0,displayClose:!0};if(e)for(var t in e)t in this.config&&(this.config[t]=e[t]);this.is_box_open=!1,this._loaded_attachments_list={}},BlackBox.prototype.alert=function(e,t){var t=this.getCallBack("onConfirm",!0,[t]),n=this.closeBox;this.createGap();var r="<div class = 'system alert'><p>"+e+"</p></div>";return this.createBox(r),this.createButton(_onConfirm=function(){n(),t()},!1,!1),!0},BlackBox.prototype.confirm=function(e,t){this.createGap();var n="<div class = 'system confirm'><p>"+e+"</p></div>",r=this.getCallBack("onConfirm",!0,[t]),i=this.getCallBack("onCancel",!1,[t]),s=this.closeBox;return this.createBox(n),this.createButton(_onConfirm=function(){s(),r()},_onCancel=function(){s(),i()},!1),!0},BlackBox.prototype.prompt=function(e,t,r,i){this.createGap();var s="<div class = 'system prompt'><p>"+e+"</p><p><input id='BlackBoxinput'  /></p></div>";this.createBox(s);var o=n("input#BlackBoxinput"),u=this.getConfig("Default",!0,[t,r,i]),a=this.getCallBack("onConfirm",!0,[t,r,i]),f=this.getCallBack("onCancel",!1,[t,r,i]);u&&o.attr("placeholder",u),o.focus();var l=this.closeBox;return this.createButton(_onConfirm=function(){var e=o.val();!e&&!t.allowPromptBlank?n.BlackBoxShake():(l(),a(e))},_onCancel=function(){l(),f()},!1),!0},BlackBox.prototype.inline=function(e,t,r){var i=n(e),s=this.getConfig("width",!1,[t,r])*1||i.width(),o=this.getConfig("height",!1,[t,r])*1||i.height(),u=this.getConfig("allowBoxScrolling",!1,[t,r]),a=this.getCallBack("onClose",!0,[t,r]),f=this.getConfig("displayClose",!1,[t,r]),l=this.createButton,c=this.closeBox;return this.createGap(),this.createBox("<div id ='BlackBoxIframe'></div>",s,o),i.wrap("<div id = 'BlackBoxPlaceHolder'></div>").appendTo(n("#BlackBoxIframe")).show(),u||n("#BlackBoxIframe").css("overflow","hidden"),f&&this.createButton(!1,!1,_onClose=function(){n(e).hide().appendTo(n("#BlackBoxPlaceHolder")).unwrap(),c(),a()}),!0},BlackBox.prototype.iframe=function(t,r,s){function m(){var e=i.width(),t=i.height();return width=o?Math.min(o,e-180):e-180,height=u?Math.min(u,t-150):t-150,n("#BlackBoxIframe").attr({width:width,height:height}),[width,height]}function b(){c&&h(!1,!1,_onClose=function(){p(),l()})}var o=this.getConfig("width",!1,[r,s])*1,u=this.getConfig("height",!1,[r,s])*1,a=this.getConfig("allowBoxScrolling",!1,[r,s]),f=this.getConfig("forceLoad",!1,[r,s]),l=this.getCallBack("onClose",!0,[r,s]),c=this.getConfig("displayClose",!1,[r,s]),h=this.createButton,p=this.closeBox,d=this.load,v=this.ready;this.createGap();var g=m(),y='<iframe id="BlackBoxIframe"  frameborder="0" hspace="0" width='+g[0]+" height="+g[1]+" src="+t+(n.browser.msie?' allowtransparency="true"':"")+"></iframe>";this.createBox(y,g[0],g[1]+5,!0),$this=n("#BlackBoxIframe"),a||$this.attr("scrolling","no"),f?(d(),$this.hide(),$this.load(function(){v(),$this.show(),b()})):b(),n(e).resize(function(){var e=m(),t=i.width(),r=i.height();n("#BlackBoxContent").css({left:(t-e[0]-18)/2,top:(r-e[1]-23)/2}),n("#BlackBoxContent > .Outer , #BlackBoxContent ").css({width:e[0]+18,height:e[1]+23})})},BlackBox.prototype.load=function(t){function r(){var e=i.width(),t=i.height();n("#BlackBoxload").css({left:(e-n("#BlackBoxload").width())/2,top:(t-n("#BlackBoxload").height())/2})}t&&this.createGap(),n("#BlackBox").append("<div id='BlackBoxload'>载入中</div>"),r(),n(e).resize(function(){r()})},BlackBox.prototype.ready=function(e){n("#BlackBoxIframe").hide().appendTo(n("#BlackBoxPlaceHolder")).unwrap(),n("#BlackBoxIframe").children().unwrap().hide(),e?this.closeBox():n("#BlackBoxload").remove()},BlackBox.prototype.closeBox=function(){n("#BlackBoxIframe").hide().appendTo(n("#BlackBoxPlaceHolder")).unwrap(),n("#BlackBoxIframe").children().unwrap().hide(),this.is_box_open&&n("#BlackBox").remove(),is_box_open=!1},BlackBox.prototype.setBackground=function(t,r,s,o){function a(){var e=i.width(),t=i.height();_BlackBoxAttachmentFullScreen(e,t),n("#BlackBoxGap").css({width:e,height:t}).fadeTo(0,o)}var t=t||this.getConfig("backgroundColor",!1,[]),r=r||this.getConfig("blackgroundImage",!1,[]),s=s||this.getConfig("backgroundImageType",!1,[]),o=o*1||.6,u=this._loaded_attachments_list;this.config.backgroundColor=t,this.config.blackgroundImage=r,this.config.backgroundImageType=s,_BlackBoxAttachmentFullScreen=n.noop,n("#BlackBoxAttachmentContainer").html()&&n("#BlackBoxAttachmentContainer").remove(),s=="repeat"&&n("#BlackBoxGap").css({"background-color":t,"background-image":"url("+r+")","background-repeat":"repeat"}),s=="fullscreen"&&(n("#BlackBox").append("<div id = 'BlackBoxAttachmentContainer'><img id = 'BlackBoxAttachment' src = '"+r+"'/ ></div>"),n("#BlackBoxAttachment").fadeTo(0,0).load(function(){n(this).fadeTo("fast",1);if(r in u){var e=u[r].split("-");_attachment_width=e[0],_attachment_height=e[1]}else{var t=new Image;t.src=r,_attachment_width=t.width,_attachment_height=t.height,u[r]=_attachment_width+"-"+_attachment_height}_BlackBoxAttachmentFullScreen=function(e,t){n("#BlackBoxAttachmentContainer").css({height:t,width:e});var r=Math.max(e/(_attachment_width*1),t/_attachment_height*1);n("#BlackBoxAttachment").attr({width:r*_attachment_width,height:r*_attachment_height})},_BlackBoxAttachmentFullScreen(i.width(),i.height())})),n("#BlackBoxAttachment").unbind("click"),this.config.clickBackgrounEffert=="shake"?n("#BlackBoxAttachment").click(function(){n.BlackBoxShake()}):this.config.clickBackgrounEffert=="close"&&n("#BlackBoxAttachment").click(function(){_close()}),a(),n(e).resize(function(){a()})},BlackBox.prototype.createButton=function(e,t,r){if(e||t)n("#BlackBoxContent > .Inner").append("<div id = actions></div>"),e&&(n(".Inner > #actions").prepend("<div class = confirm>确认</div>"),n("#actions > .confirm").click(function(){e()})),t&&(n(".Inner > #actions").prepend("<div class = cancel>取消</div>"),n("#actions > .cancel").click(function(){t()}));r&&(n(".Outer").prepend("<div class = close>关闭</div>"),n(".Outer > .close").click(function(){r()}))},BlackBox.prototype.createBox=function(t,r,s,o){function f(){var e=i.width(),t=i.height(),r=inner_width+18,s=inner_height+18;n("#BlackBoxContent").css({left:(e-r)/2,top:(t-s)/2,width:r,height:s}),n("#BlackBoxContent > .Outer").css({width:r,height:s}).fadeTo(0,.6)}n("#BlackBox").append("<div id=BlackBoxContent></div>");var u="<div class = Outer></div><div class = Inner>"+t+"</div>",a=this.closeBox;n("#BlackBoxContent").html(u).fadeIn("fast"),inner_width=r||n("#BlackBoxContent > .Inner").width(),inner_height=s||n("#BlackBoxContent > .Inner").height(),f(),this.config.clickBackgrounEffert=="shake"?n("#BlackBoxGap").click(function(){n.BlackBoxShake()}):this.config.clickBackgrounEffert=="close"&&n("#BlackBoxGap").click(function(){a()}),o||n(e).resize(function(){f()})},BlackBox.prototype.createGap=function(){this._init_(),n("body").append("<div id='BlackBox'><div id='BlackBoxGap'></div></div>");var r=i.width(),s=i.height();n.browser.msie&&n.browser.version=="6.0"&&n(e).scroll(function(){n("#BlackBox").css({position:"absolute",top:n(t).scrollTop()})}),this.setBackground()},BlackBox.prototype.getConfig=function(e,t,n){return this._getBase("string",e,t,n)},BlackBox.prototype.getCallBack=function(e,t,r){var i=this._getBase("function",e,t,r);return i?i:n.noop},BlackBox.prototype._init_=function(){n("#BlackBoxIframe").hide().appendTo(n("#BlackBoxPlaceHolder")).unwrap(),n("#BlackBoxIframe").children().unwrap().hide(),n("#BlackBox").html()&&n("#BlackBox").remove(),is_box_open=!0},BlackBox.prototype._getBase=function(e,t,n,r){for(var i in r)switch(typeof r[i]){case e:if(n)return r[i];break;case"object":try{for(var s in r[i])if(s==t&&typeof r[i][s]==e)return r[i][s];break}catch(o){break}}return this.config[t]},n.BlackBoxShake=function(){var e=n("#BlackBoxContent"),t=e.offset().left;for(var r=1;4>=r;r++)e.animate({left:t-(12-3*r)},50),e.animate({left:t+2*(12-3*r)},50)},n.alert=function(e,t){var n=new BlackBox;n.alert(e,t)},n.confirm=function(e,t){var n=new BlackBox;n.confirm(e,t)},n.prompt=function(e,t,n){var r=new BlackBox;r.prompt(e,t,n)},n.closeBox=function(){var e=new BlackBox;e.closeBox()},n.boxLoad=function(){var e=new BlackBox;e.load(!0)},n.boxReady=function(){var e=new BlackBox;e.ready(!0)},n.fn.extend({blackBoxIframe:function(e,t){var r=n(this);r.click(function(){var n=new BlackBox;return n.iframe(r.attr("href"),e,t),!1})}}),n.fn.extend({blackBoxInline:function(e,t){var r=n(this),i=n(r.attr("href"));alert(r.attr("href")),r.click(function(){var n=new BlackBox;return n.inline(i,e,t),!1})}})})(window,document,jQuery)